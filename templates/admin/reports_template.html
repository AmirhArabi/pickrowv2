{% extends 'admin/base_site.html' %}
{% load static %}
{% load heroicons %}

{% block content %}
  <div class="flex flex-col gap-4 bg-white p-4 rounded-2xl border border-gray-200">
    {% if error %}
      <!-- show alert if no data -->
      <div id="toast-default" class="flex items-center w-full p-4 text-red-900 rounded-lg shadow-sm border-2 border-3 border-red-600 bg-red-50" role="alert">
        <div class="ms-3 text-xl font-normal">{{ error }}</div>
        <button type="button" class="border border-red-600 ms-auto -mx-1.5 -my-1.5 bg-red-200 text-gray-900 hover:text-gray-900 rounded-lg focus:ring-2 focus:ring-gray-300 p-1.5 inline-flex items-center justify-center h-8 w-8" data-dismiss-target="#toast-default" aria-label="Close">
          <span class="sr-only">Close</span>
          {% heroicon_outline 'x-mark' size=40 %}
        </button>
      </div>
    {% endif %}

      <div class="flex flex-col md:flex-row gap-4">
        
      
        <div class="w-full p-4 border border-gray-200 bg-white rounded-xl shadow-lg md:w-2/3">
                <div class="flex flex-row justify-between">
                  <h2 class='font-bold text-xl mb-4'> Statics </h2>
                  <h2 >updated : {{ now }} </h2> 
                </div>

                <div class="flex flex-wrap gap-4 p-2">
                  <!-- card User -->
                  <div class="flex items-center p-2 bg-white flex-1 border-r">
                    <div class="flex items-center justify-center w-12 h-12 bg-blue-100 rounded-lg mr-4">
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6 text-blue-600">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 0 0 2.625.372 9.337 9.337 0 0 0 4.121-.952 4.125 4.125 0 0 0-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 0 1 8.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0 1 11.964-3.07M12 6.375a3.375 3.375 0 1 1-6.75 0 3.375 3.375 0 0 1 6.75 0Zm8.25 2.25a2.625 2.625 0 1 1-5.25 0 2.625 2.625 0 0 1 5.25 0Z" />
                      </svg>

                    </div>
                    <div>
                      <div class="text-2xl font-bold">{{ card_data.unique_userinfo_records}}</div>
                      <div class="text-sm text-gray-500">User</div>
                    </div>
                  </div>

                  <!-- card verifed -->
                  <div class="flex items-center p-4 bg-white flex-1 border-r">
                    <div class="flex items-center justify-center w-12 h-12 bg-green-100 rounded-lg mr-4">
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6 text-green-600">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75m-3-7.036A11.959 11.959 0 0 1 3.598 6 11.99 11.99 0 0 0 3 9.749c0 5.592 3.824 10.29 9 11.623 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.285Z" />
                      </svg>



                    </div>
                    <div>
                      <div class="text-2xl font-bold">{{ card_data.checked_products}}</div>
                      <div class="text-sm text-gray-500">verifed</div>
                    </div>
                  </div>

                  <!-- card product -->
                  <div class="flex items-center p-4 bg-white flex-1 border-r">
                    <div class="flex items-center justify-center w-12 h-12 bg-yellow-100 rounded-lg mr-4">
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6 text-yellow-600">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m20.25 7.5-.625 10.632a2.25 2.25 0 0 1-2.247 2.118H6.622a2.25 2.25 0 0 1-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125Z" />
                      </svg>
                    </div>
                    <div>
                      <div class="text-2xl font-bold">{{ card_data.total_products}}</div>
                      <div class="text-sm text-gray-500">product</div>
                    </div>
                  </div>

                  <!-- card Parts -->
                  <div class="flex items-center p-4 bg-white flex-1">
                    <div class="flex items-center justify-center w-12 h-12 bg-red-100 rounded-lg mr-4">
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6 text-red-600">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6.429 9.75 2.25 12l4.179 2.25m0-4.5 5.571 3 5.571-3m-11.142 0L2.25 7.5 12 2.25l9.75 5.25-4.179 2.25m0 0L21.75 12l-4.179 2.25m0 0 4.179 2.25L12 21.75 2.25 16.5l4.179-2.25m11.142 0-5.571 3-5.571-3" />
                      </svg>


                    </div>
                    <div>
                      <div class="text-2xl font-bold">{{ card_data.unique_part_numbers}}</div>
                      <div class="text-sm text-gray-500">Parts</div>
                    </div>
                  </div>
                  
                </div>
                  
        </div>
        <div class="w-full md:w-1/3 p-4 border border-gray-200 bg-white rounded-xl shadow-lg">
                
          <a href="#" class="flex flex-col items-center bg-white shadow-sm md:flex-row md:max-w-xl ">
              <div class="flex flex-col justify-between p-4 leading-normal">
                  <h5 class="mb-2 text-xl font-bold text-gray-900">Export Saved Data</h5>
                  <p class="mb-3 font-normal text-gray-700 dark:text-gray-400">Here are you can view and save or export product and customers data.</p>
                  <button onclick="window.location.href='{% url 'admin_exports' %}'" type="button" class="w-full text-blue-400 bg-white border border-blue-500 hover:bg-blue-800 hover:text-white focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center">
                    View Page 
                  </button>
              </div>
              <img class="object-cover w-full rounded-t-lg h-96 md:h-auto md:w-48 md:rounded-none md:rounded-s-lg" src="{% static 'images/data.jpg'%}" alt="data export image">
          </a>
       
        </div>

      </div>
      <div class="flex flex-col gap-8 lg:flex-row">

          <div class="mt-6 w-full md:w-1/3 bg-white border border-gray-300 shadow-xl p-4 rounded-2xl">
            <h2 class='font-bold text-xl mb-4'> Product Check </h2>
            <div id="product-check-chart" class="w-full h-min"></div>
            <div class="flex flex-row justify-between mt-4">
              <div class="flex flex-col">
                  <h2 class='font-bold text-xl mb-4'> Total Check </h2>
                  <p class="text-gray-500">Total check of all products</p>
                </div>
                <div class="flex flex-col">
                  <h2 class='font-bold text-xl mb-4'> {{ card_data.total_checks }} </h2>
                  <p class="text-gray-500">
                    <span class="text-green-500 text-lg font-bold">{{ checked_products_count }} </span> of <span class="text-red-500 text-lg font-bold"> {{ products_count }}</span> </p>
                </div>
              </div>
            </div>

        <div class="mt-6 w-full md:w-2/3 bg-white border border-gray-300 shadow-xl p-4 rounded-2xl">
          <h2 class='font-bold text-xl mb-4'> Buyers Chart </h2>
          <div id="buyers-chart"></div>
          <div class="flex flex-row justify-between mt-4">
            <div class="flex flex-col">
              <h2 class='font-bold text-xl mb-4'> Total Buyers </h2>
            </div>
            <div class="flex flex-col">
              <h2 class='font-bold text-xl mb-4 text-blue-800'>
                {{ all_buyers|length }} Person
              </h2>
            </div>
          </div>

        </div>
      </div>


      
      <div class="flex flex-col md:flex-row gap-4">
        <div class="mt-6 w-full bg-white border border-gray-300 shadow-xl p-4 rounded-2xl sm:w-2/3">
            <h2 class='font-bold text-xl mb-4'> Checked Product Chart </h2>
            <div id="monthlyChart"></div>
            <div class="flex flex-row justify-between mt-4">
              <div class="flex flex-col">
                <h2 class='font-bold text-xl mb-4'> Total Checked Product In Last 12 Month </h2>
              </div>
              <div class="flex flex-col">
                <h2 class='font-bold text-xl mb-4 text-sky-500'>
                  {{ monthly_report_counts }} Product
                </h2>
              </div>
            </div>
        </div>


        <div class="mt-6 w-full bg-white border border-gray-300 shadow-xl p-4 rounded-2xl sm:w-1/3">
            <h2 class='font-bold text-xl mb-4'> User Country Distribution </h2>
            <div id="CountryDistributionChart" class="w-full h-min"></div>
            <div class="flex flex-row justify-between mt-4">
              <div class="flex flex-col">
                  <h2 class='font-bold text-xl mb-4'> Total User </h2>
                  <p class="text-gray-500">user of all countries</p>
                </div>
                <div class="flex flex-col">
                  <h2 class='font-bold text-xl mb-4'> {{ card_data.total_checks }} </h2>
                  <p class="text-gray-500">
                    <span class="text-sky-500 text-lg font-bold">{{ user_distribution_country_total }} </span> user in <span class="text-sky-950 text-lg font-bold"> {{ user_distribution_country_count }} country</span> </p>
                </div>
              </div>
          </div>  
      </div>

      <div class="mt-6  bg-white border border-gray-300 shadow-xl p-4 rounded-2xl">
          <div id="worldMap"></div>
          <div class="flex flex-row justify-between mt-4">
            <div class="flex flex-col">
              <h2 class='font-bold text-xl mb-4'> Total Countries </h2>
            </div>
            <div class="flex flex-col">
              <h2 id="total-countries" class='font-bold text-xl mb-4 text-sky-700'>
                
              </h2>
            </div>
          </div>
      </div>

      <div class="flex flex-row gap-8 lg:flex-row">
        <div class="w-full p-4 border border-gray-200 bg-white rounded-xl shadow-lg overflow-x-auto md:overflow-visible touch-pan-x">
          <h2 class='font-bold text-xl mb-4'> Product List </h2>
          <table class="w-full text-sm text-left text-gray-500 overflow-x-auto bg-white">
            <thead class="text-xs text-gray-500 uppercase bg-gray-50 ">
              <tr>
                <th scope="col" class="px-6 py-3">Product Name</th>
                <th scope="col" class="px-6 py-3">Total Count</th>
                <th scope="col" class="px-6 py-3">Part Count</th>
                <th scope="col" class="px-6 py-3">Verified Product</th>
                <th scope="col" class="px-6 py-3">Unverified Product</th>
                <th scope="col" class="px-6 py-3">Last Updated</th>
                <th scope="col" class="px-6 py-3">Most Checked Part</th>
                <th scope="col" class="px-6 py-3">Most UnChecked Part</th>
                <th scope="col" class="px-6 py-3">Most Used Country</th>
              </tr>
            </thead>
            <tbody>
              {% for product in categories_data %}
                <tr class="border-b hover:bg-blue-50 {% cycle 'bg-white' 'bg-gray-50' %}">
                  <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap border-t">
                    <a href="{% url 'admin_product_detail' product_id=product.id %}" class="text-blue-700 hover:underline flex items-center align-center">
                      {% heroicon_outline "bars-3" size="22" class="text-gray-500 mr-2" %} {{ product.name }}
                    </a>
                  </td>
                  <td class="px-6 py-4 border-t">{{ product.total_products }}</td>
                  <td class="px-6 py-4 border-t">{{ product.unique_parts }}</td>
                  <td class="px-6 py-4 border-t">{{ product.verified_products }}</td>
                  <td class="px-6 py-4 border-t">{{ product.unverified_products }}</td>
                  <td class="px-6 py-4 border-t">{{ product.last_updated }}</td>
                  <td class="px-6 py-4 border-t whitespace-nowrap">Part {{ product.most_used_part.part_number }} : {{ product.most_used_part.total_checks }}</td>
                  <td class="px-6 py-4 border-t whitespace-nowrap">Part {{ product.most_unused_part.part_number }} : {{ product.most_unused_part.total_checks }}</td>
                  <td class="px-6 py-4 border-t">
                    {% if product.most_used_country %}
                      {{ product.most_used_country.0.user_info__country }}
                    {% else %}
                      <span class="text-gray-300">No data</span>
                    {% endif %}
                    </td>

                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      
  <script src="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts@3.46.0/dist/apexcharts.min.js"></script>
  <script src="https://code.highcharts.com/maps/highmaps.js"></script>
  <script src="https://code.highcharts.com/maps/modules/exporting.js"></script>
  <script src="https://code.highcharts.com/mapdata/custom/world.js"></script>
  

  <script>
    var percentage = {{ percentage }};

    var product_check = {
          series: [percentage],
          chart: {
          height: 350,
          type: 'radialBar',
          toolbar: {
            show: true
          }
        },
        plotOptions: {
          radialBar: {
            startAngle: -135,
            endAngle: 225,
             hollow: {
              margin: 0,
              size: '70%',
              background: '#fff',
              image: undefined,
              imageOffsetX: 0,
              imageOffsetY: 0,
              position: 'front',
              dropShadow: {
                enabled: true,
                top: 3,
                left: 0,
                blur: 4,
                opacity: 0.5
              }
            },
            track: {
              background: '#fff',
              strokeWidth: '67%',
              margin: 0, // margin is in pixels
              dropShadow: {
                enabled: true,
                top: -3,
                left: 0,
                blur: 4,
                opacity: 0.7
              }
            },
        
            dataLabels: {
              show: true,
              name: {
                offsetY: -10,
                show: true,
                color: '#888',
                fontSize: '17px'
              },
              value: {
                formatter: function(val) {
                  return parseInt(val);
                },
                color: '#111',
                fontSize: '36px',
                show: true,
              }
            }
          }
        },
        fill: {
          type: 'gradient',
          gradient: {
            shade: 'dark',
            type: 'horizontal',
            shadeIntensity: 0.5,
            gradientToColors: ['#ABE5A1'],
            inverseColors: true,
            opacityFrom: 1,
            opacityTo: 1,
            stops: [0, 100]
          }
        },
        stroke: {
          lineCap: 'round'
        },
        labels: ['Percent'],
        };

        var chart = new ApexCharts(document.querySelector("#product-check-chart"), product_check);
        chart.render();
  </script>
  <script>
    const buyerNames = JSON.parse('{{ buyer_names_json|escapejs }}');
    const checkedCounts = JSON.parse('{{ checked_counts_json|escapejs }}');
    
    var options = {
        series: [{
            name: 'Checked Products',
            data: checkedCounts
        }],
        chart: {
            height: 350,
            type: 'bar',
            toolbar: {
                show: true
            },
            events: {
                click: function(chart, w, e) {
                    console.log(chart, w, e);
                }
            }
        },
        colors: ['#1A56DB', '#FDBA8C'],
        plotOptions: {
            bar: {
                columnWidth: '25%',
                distributed: true,
                borderRadiusApplication: "end",
                borderRadius: 8,
            }
        },
        stroke: {
            curve: "smooth",
            width: 2,
            lineCap: 'round',
        },
        grid: {
            show: false,
            strokeDashArray: 4,
            padding: {
                top: -14,
                right: 2,
                left: 2
            },
        },
        markers: {
            shape: "circle",
            radius: 5,
        },
        dataLabels: {
            enabled: false
        },
        legend: {
            show: false
        },
        xaxis: {
            categories: buyerNames,
            labels: {
                style: {
                    colors: '#1A56DB',
                    fontSize: '12px',
                },
                formatter: function(value) {
                    return value || '';
                }
            },
            axisTicks: {
              show: false,
            }
        },
        yaxis: {
            title: {
                text: 'Total Products',
                style: {
                    color: '#1A56DB',
                    fontSize: '16px',
                    fontWeight: 'bold'
                }
            }
        },
        tooltip: {
            y: {
                formatter: function(val) {
                    return val + " product";
                }
            }
        }
    };
    var chart = new ApexCharts(document.querySelector("#buyers-chart"), options);
    chart.render();
</script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const options = {
            series: [{
                name: 'checked product count',
                data: {{ monthly_report_count|safe }}
            }],
            chart: {
                height: 350,
                type: 'area',
                rtl: true,
                toolbar: {
                    show: true
                },
                dropShadow: {
                  enabled: false,
                },
                zoom: {
                    enabled: false
                }
            },
            fill: {
              type: "gradient",
              gradient: {
                opacityFrom: 0.55,
                opacityTo: 0,
                shade: "#1C64F2",
                gradientToColors: ["#1C64F2"],
              }
            },
            colors: ['#1A56DB'],
            stroke: {
                width: 3,
            },
            markers: {
                size: 5,
                hover: {
                    size: 7
                }
            },
            xaxis: {
                categories: {{ monthly_report_months|safe }},
                labels: {
                    style: {
                        fontSize: '12px',
                    },
                    formatter: function(value) {
                        return value;
                    }
                }
            },
            yaxis: {
                title: {
                    text: 'checked products',
                    style: {
                        fontSize: '16px',
                        fontWeight: 'bold',
                        color: '#1A56DB'
                    }
                },
                min: 0
            },
            
            tooltip: {
                y: {
                    formatter: function(val) {
                        return val + " checked products";
                    }
                }
            },
            dataLabels: {
                enabled: false
            },
            grid: {
                borderColor: '#f1f1f1',
                show: true,
                strokeDashArray: 4,
                padding: {
                  left: 2,
                  right: 2,
                  top: 0,
                },
            }
        };

        const chart = new ApexCharts(document.querySelector("#monthlyChart"), options);
        chart.render();
    });
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  
    const countriesData = JSON.parse('{{ countries_json|escapejs }}');
    const mapData = countriesData.map(country => ({
        'hc-key': country.country_short.toLowerCase(),
        'name': country.country,
        'value': country.total_checks
    }));
    document.querySelector('#total-countries').innerHTML = countriesData.length + ' Country';
    
    Highcharts.mapChart('worldMap', {
        chart: {
            map: 'custom/world',
        }, 
        title: {
            text: 'Country Wise Product Check',
            alert: false,
            style: {
                fontSize: '20px',
                fontWeight: 'bold',
            },
            align : 'left',
            verticalAlign: 'top',
        },       
        mapNavigation: {
            enabled: true,
            buttonOptions: {
                verticalAlign: 'bottom'
            }
        },
        colorAxis: {
            min: 0,
            minColor: '#E6E6E6',
            maxColor: '#1A56DB'
        },
        
        series: [{
            data: mapData,
            states: {
                hover: {
                    color: '#7cade6'
                }
            },
            dataLabels: {
                enabled: false,
            },
            tooltip: {
                pointFormat: '{point.name}: <b>{point.value}</b> products'
            }
        }],
        
        credits: {
            enabled: false
        }
    });
});
</script>
<script>


document.addEventListener('DOMContentLoaded', function() {
    try {
        
        const rawData = JSON.parse('{{ user_distribution_country|safe }}');
    
    const options = {
        series: rawData.map(item => item.count),
        dataLabels: {
            enabled: false,
        },
        chart: {
            type: 'donut',
            height: 400,
            fontFamily: 'Vazir, Tahoma',
            toolbar:{
              show: true,
              tools:{
                download: true,
              }
            },
            animations: {
                enabled: true,
                speed: 800
            }
        },
        labels: rawData.map(item => item.country),
        colors: ['#003f5c', '#374c80', '#7a5195', '#bc5090', '#ef5675'],
        plotOptions: {
            pie: {
                donut: {
                    size: '70%',
                    labels: {
                        show: true,
                        name: {
                            show: true,
                            fontFamily: "Inter, sans-serif",
                            offsetY: 20,
                        },
                        total: {
                            showAlways: true,
                            show: true,
                            label: 'Total Users',
                            formatter: function (w) {
                              const sum = w.globals.seriesTotals.reduce((a, b) => {
                                return a + b
                              }, 0)
                              return sum
                            },
                        },
                        value: {
                          show: true,
                          fontFamily: "Inter, sans-serif",
                          offsetY: -20,
                          formatter: function (value) {
                            return value 
                          },
                        },
                        name: {
                            offsetY: 20
                        }
                    }
                }
            }
        },
        legend: {
            position: 'bottom',
            formatter: function(seriesName, opts) {
                return seriesName + ': ' + opts.w.globals.series[opts.seriesIndex] 
            },
            horizontalAlign: 'center',
            markers: {
                radius: 4
            },
            itemMargin: {
                horizontal: 10,
                vertical: 5
            }
        },
        yaxis: {
          labels: {
            formatter: function (value) {
              return value + ' users' + '- percent: ' + ((value / rawData.reduce((a, b) => a + b.count, 0)) * 100).toFixed(1) + '%';
            },
          },
        },
        responsive: [{
            breakpoint: 768,
            options: {
                chart: {
                    height: 300
                },
                legend: {
                    position: 'bottom'
                }
            }
        }]
    };
        
        const chart = new ApexCharts(document.querySelector("#CountryDistributionChart"), options);
        chart.render();
        
    } catch (error) {
        console.error('Chart initialization failed:', error);
        document.getElementById('donutChart').innerHTML = `
            <div class="p-4 bg-red-50 text-red-600 rounded">
                cant show chart data please call to admin!!!
            </div>
        `;
    }
});

</script>
  
{% endblock %}
